# Cosign Image Signing Workflow for R-SRP Ultra
# Implements container image signing and verification

name: Image Signing & Cosign

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  # Cosign configuration
  COSIGN_EXPERIMENTAL: "1"
  COSIGN_REPOSITORY: ghcr.io
  IMAGE_REGISTRY: ghcr.io
  IMAGE_NAME: laeyesprod/r-srp

jobs:
  build-and-sign:
    name: Build, Sign & Verify Container Image
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.10.1
      
      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.real-crypto
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.description=R-SRP Ultra - Zero-Trust Banking Registry
            org.opencontainers.image.licenses=EUPL-1.2
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Sign the image with Cosign (Keyless OIDC)
        if: github.event_name != 'pull_request'
        env:
          IMAGE_URL: "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        run: |
          # Keyless signing with OIDC (no static keys)
          cosign sign --yes $IMAGE_URL
          
          # Also sign with KMS for additional security (optional)
          # cosign sign --key kms://key:///rsrp-ultra/signing-key $IMAGE_URL
      
      - name: Verify Cosign signature
        if: github.event_name != 'pull_request'
        run: |
          IMAGE_URL="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          
          # Verify the signature
          cosign verify $IMAGE_URL
      
      - name: Generate SBOM for container
        if: github.event_name != 'pull_request'
        run: |
          IMAGE_URL="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          
          # Generate SBOM using syft
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft $IMAGE_URL -o spdx-json > container-sbom.spdx.json

      - name: Install jq
        if: github.event_name != 'pull_request'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: Attest SBOM
        if: github.event_name != 'pull_request'
        run: |
          IMAGE_URL="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          
          # Create attestation
          echo '{}' | jq '.subject = [{"name": "container-sbom.spdx.json", "digest": {"sha256": "'$(sha256sum container-sbom.spdx.json | cut -d' ' -1)'"}}]' > attestation.json
          
          # Attest the SBOM
          cosign attest --type spdx --predicate attestation.json --yes $IMAGE_URL
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: github.event_name != 'pull_request'
        with:
          name: signing-artifacts
          path: |
            container-sbom.spdx.json
            attestation.json
          retention-days: 30
      
      - name: Create GitHub Release
        if: github.event_name == 'release' && github.event.action == 'published'
        run: |
          # Create OIDC token for attestations
          cosign initialize
          
          # Verify and attest release
          cosign verify-attestation ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

  # Verify signatures in CI
  verify-signatures:
    name: Verify Image Signatures
    runs-on: ubuntu-latest
    needs: build-and-sign
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.10.1
      
      - name: Verify image signature
        run: |
          # This would verify a pre-built image in a real scenario
          echo "Verifying signatures for pull request builds..."
          echo "In production, this would verify against a known-good registry"

  # Generate provenance (SLSA)
  provenance:
    name: Generate SLSA Provenance
    runs-on: ubuntu-latest
    needs: build-and-sign
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.10.1
      
      - name: Create and upload SLSA provenance
        run: |
          # Create provenance predicate
          cat > provenance.json << 'EOF'
          {
            "_type": "https://in-toto.io/Statement/v0.1",
            "predicateType": "https://slsa.dev/provenance/v0.2",
            "predicate": {
              "builder": {
                "id": "https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator@v1"
              },
              "buildType": "https://github.com/slsa-framework/slsa-github-generator/generic@v1",
              "invocation": {
                "configSource": {
                  "uri": "git+https://github.com/${{ github.repository }}@${{ github.ref }}",
                  "digest": {"sha1": "${{ github.sha }}"},
                  "entryPoint": "Workflow"
                }
              },
              "metadata": {
                "invocationId": "${{ github.run_id }}",
                "startedOn": "${{ github.event.repository.created_at }}"
              }
            }
          }
          EOF
      
      - name: Sign provenance
        run: |
          cosign sign-blob --yes \
            --output-signature provenance.sig \
            --output-certificate provenance.pem \
            provenance.json
      
      - name: Upload provenance
        uses: actions/upload-artifact@v4
        with:
          name: provenance
          path: |
            provenance.json
            provenance.sig
            provenance.pem
          retention-days: 365
