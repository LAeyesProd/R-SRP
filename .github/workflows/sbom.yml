# SBOM workflow for RSRP
# Generates CycloneDX SBOM, signs it with keyless Cosign, and publishes artifacts.

name: SBOM

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 0"

env:
  CARGO_TERM_COLOR: always

jobs:
  sbom:
    name: Generate and Sign CycloneDX SBOM
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Prefetch dependencies
        run: cargo fetch --locked

      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx --locked

      - name: Generate CycloneDX SBOM
        run: |
          cargo cyclonedx --manifest-path Cargo.toml --all --all-features --format json
          mkdir -p sbom
          find . -type f \( -name "*.cdx.json" -o -name "bom.json" -o -name "*.bom.json" \) \
            -not -path "./target/*" \
            -exec cp --parents {} sbom/ \;
          test -n "$(find sbom -type f)"

      - name: Archive SBOM bundle
        run: |
          ARCHIVE="rsrp-sbom-${GITHUB_SHA}.tar.gz"
          tar -czf "${ARCHIVE}" -C sbom .
          sha256sum "${ARCHIVE}" > "${ARCHIVE}.sha256"
          echo "SBOM_ARCHIVE=${ARCHIVE}" >> "${GITHUB_ENV}"

      - name: Install Cosign
        if: github.event_name != 'pull_request'
        uses: sigstore/cosign-installer@v3.7.0

      - name: Sign SBOM bundle (keyless)
        if: github.event_name != 'pull_request'
        run: |
          cosign sign-blob --yes \
            --output-signature "${SBOM_ARCHIVE}.sig" \
            --output-certificate "${SBOM_ARCHIVE}.pem" \
            "${SBOM_ARCHIVE}"

      - name: Verify SBOM signature
        if: github.event_name != 'pull_request'
        run: |
          cosign verify-blob \
            --certificate "${SBOM_ARCHIVE}.pem" \
            --signature "${SBOM_ARCHIVE}.sig" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity-regexp "https://github.com/${{ github.repository }}/.github/workflows/sbom.yml@.*" \
            "${SBOM_ARCHIVE}"

      - name: Upload SBOM artifacts (PR)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: signed-sbom-${{ github.sha }}
          path: |
            sbom/**
            ${{ env.SBOM_ARCHIVE }}
            ${{ env.SBOM_ARCHIVE }}.sha256
          retention-days: 90

      - name: Upload signed SBOM artifacts
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: signed-sbom-${{ github.sha }}
          path: |
            sbom/**
            ${{ env.SBOM_ARCHIVE }}
            ${{ env.SBOM_ARCHIVE }}.sha256
            ${{ env.SBOM_ARCHIVE }}.sig
            ${{ env.SBOM_ARCHIVE }}.pem
          retention-days: 90

      - name: Publish SBOM assets on release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.SBOM_ARCHIVE }}
            ${{ env.SBOM_ARCHIVE }}.sha256
            ${{ env.SBOM_ARCHIVE }}.sig
            ${{ env.SBOM_ARCHIVE }}.pem
