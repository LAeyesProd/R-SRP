name: Production Gate

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: "0"
  CARGO_BUILD_PIPELINING: "false"
  CARGO_BUILD_JOBS: "1"
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  production-profile:
    name: Enforce Production Crypto Profile
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.93.1
        with:
          components: clippy

      - name: Install OQS toolchain (bindgen/cmake)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            clang-14 \
            llvm-14-dev \
            libclang-14-dev \
            pkg-config
          test -f /usr/lib/llvm-14/lib/libclang.so
          echo "LIBCLANG_PATH=/usr/lib/llvm-14/lib" >> "$GITHUB_ENV"

      - name: Isolate cargo directories for deterministic build
        run: |
          set -euo pipefail
          echo "CARGO_HOME=${RUNNER_TEMP}/cargo-home" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_DIR=${RUNNER_TEMP}/cargo-target" >> "$GITHUB_ENV"
          mkdir -p "${RUNNER_TEMP}/cargo-home" "${RUNNER_TEMP}/cargo-target"

      - name: Normalize rust environment
        run: |
          set -euo pipefail
          unset RUSTFLAGS || true
          unset CARGO_ENCODED_RUSTFLAGS || true
          unset CARGO_BUILD_TARGET || true
          unset RUSTC_WRAPPER || true
          unset RUSTC_WORKSPACE_WRAPPER || true
          rustup show
          cargo --version

      - name: Lockfile sync check
        run: cargo fetch --locked

      - name: Sanitize cargo build state
        run: |
          set -euo pipefail
          cargo clean
          cargo fetch --locked

      - name: Enforce zero-warning policy (clippy)
        run: |
          set -euo pipefail
          cargo clippy --workspace --all-targets --locked -- -D warnings

      - name: Enforce entropy self-test coverage
        run: |
          set -euo pipefail
          cargo test -p rsrp-security-core --locked entropy::tests::test_entropy_health_check_reports_ok -- --nocapture

      - name: Ensure no mock backend in production feature graph
        run: |
          set -euo pipefail
          cargo tree --manifest-path rsrp-demo/Cargo.toml -e features --features production > feature-tree.txt
          if grep -E "mock-crypto" feature-tree.txt; then
            echo "mock-crypto detected in production graph"
            exit 1
          fi

      - name: Build rsrp-pqcrypto in production mode
        run: |
          set -euo pipefail
          cargo build \
            -p rsrp-pqcrypto \
            --release \
            --locked \
            -j 1 \
            --no-default-features \
            --features production

      - name: Compile rsrp-pqcrypto tests in production mode
        run: |
          set -euo pipefail
          cargo test \
            -p rsrp-pqcrypto \
            --locked \
            -j 1 \
            --no-default-features \
            --features production \
            --tests \
            --no-run

  supply-chain-gate:
    name: Enforce Supply-Chain Policy
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.93.1

      - name: Install jq
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Lockfile sync check
        run: cargo fetch --locked

      - name: Install policy tools
        run: |
          set -euo pipefail
          cargo install cargo-deny --version 0.19.0 --locked
          cargo install cargo-audit --locked

      - name: Enforce cargo-deny policy
        run: |
          set -euo pipefail
          cargo deny check advisories bans licenses sources

      - name: Enforce cargo-audit policy
        run: |
          set -euo pipefail
          cargo audit --deny warnings --ignore RUSTSEC-2025-0134

      - name: Reject non-crates.io dependency sources
        run: |
          set -euo pipefail
          cargo metadata --format-version=1 --locked > metadata.json
          if jq -r '.packages[] | select(.source != null) | .source' metadata.json | grep -E '^git\+'; then
            echo "git dependencies are forbidden by policy"
            exit 1
          fi

      - name: Generate CycloneDX SBOM (gating)
        run: |
          set -euo pipefail
          cargo install cargo-cyclonedx --locked
          cargo cyclonedx --manifest-path Cargo.toml --all --all-features --format json
          find . -type f \( -name "*.cdx.json" -o -name "bom.json" -o -name "*.bom.json" \) -not -path "./target/*" -print > sbom-files.txt
          test -s sbom-files.txt

      - name: Upload gate artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-gate-artifacts
          path: |
            metadata.json
            sbom-files.txt
          retention-days: 30
